# BaseCollector - æ”¶é›†å™¨åŸºç±»

## ğŸ“‹ åŸºæœ¬ä¿¡æ¯

### æ–‡ä»¶è·¯å¾„
`src/autospider/crawler/base_collector.py`

### æ ¸å¿ƒåŠŸèƒ½
æ”¶é›†å™¨åŸºç±»ï¼ŒæŠ½å– `URLCollector` å’Œ `BatchCollector` çš„å…¬å…±é€»è¾‘ï¼Œæä¾›ç»Ÿä¸€çš„é€Ÿç‡æ§åˆ¶ã€æ–­ç‚¹ç»­çˆ¬ã€Redis æŒä¹…åŒ–ã€XPath/LLM æ”¶é›†å’Œåˆ†é¡µå¤„ç†åŠŸèƒ½ã€‚

### è®¾è®¡ç†å¿µ
é‡‡ç”¨æŠ½è±¡åŸºç±»è®¾è®¡ï¼Œå°†å…¬å…±é€»è¾‘æŠ½å–åˆ°åŸºç±»ä¸­ï¼Œå‡å°‘ä»£ç é‡å¤ï¼Œæé«˜å¯ç»´æŠ¤æ€§ã€‚åŸºç±»è´Ÿè´£ï¼š
- **èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šè‡ªåŠ¨åˆ›å»ºè¾“å‡ºç›®å½•å’Œæˆªå›¾ç›®å½•ã€‚
- **å¢é‡æŒä¹…åŒ–**ï¼šé€šè¿‡è®°å½•æœ€åä¸€æ¬¡è¿½åŠ çš„æ•°é‡ï¼Œå®ç° URL çš„é«˜æ•ˆå¢é‡ä¿å­˜ï¼Œé¿å…å…¨é‡å»é‡ I/Oã€‚
- **çŠ¶æ€åŒæ­¥**ï¼šç¡®ä¿æ‰€æœ‰å¤„ç†å™¨ï¼ˆURL æå–ã€åˆ†é¡µã€LLMã€å¯¼èˆªï¼‰å…±äº«æœ€æ–°çš„é¡µé¢å¼•ç”¨å’Œé…ç½®ã€‚

---

## ğŸ“ å‡½æ•°ç›®å½•

### ä¸»ç±»
- `BaseCollector` - URL æ”¶é›†å™¨åŸºç±»

### æ ¸å¿ƒæ–¹æ³•
- `run` - è¿è¡Œæ”¶é›†æµç¨‹ï¼ˆæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°ï¼‰
- `_collect_phase_with_xpath` - ä½¿ç”¨å…¬å…± XPath æ”¶é›† URL
- `_collect_phase_with_llm` - ä½¿ç”¨ LLM éå†åˆ—è¡¨é¡µæ”¶é›† URL
- `_extract_urls_with_xpath` - ä½¿ç”¨ XPath æå–å½“å‰é¡µçš„ URL
- `_collect_page_with_llm` - ä½¿ç”¨ LLM æ”¶é›†å•é¡µçš„ URL
- `_resume_to_target_page` - ä½¿ç”¨ä¸‰é˜¶æ®µç­–ç•¥æ¢å¤åˆ°ç›®æ ‡é¡µ

### è¾…åŠ©æ–¹æ³•
- `_init_redis_manager` - åˆå§‹åŒ– Redis ç®¡ç†å™¨
- `_initialize_handlers` - åˆå§‹åŒ–å„ä¸ªå¤„ç†å™¨
- `_sync_page_references` - åŒæ­¥é¡µé¢å¼•ç”¨åˆ°å„å¤„ç†å™¨
- `_is_progress_compatible` - æ£€æŸ¥è¿›åº¦æ˜¯å¦ä¸å½“å‰ä»»åŠ¡åŒ¹é…
- `_load_previous_urls` - ä» Redis æˆ–æœ¬åœ°æ–‡ä»¶åŠ è½½å†å² URL
- `_save_progress` - ä¿å­˜å½“å‰æ”¶é›†è¿›åº¦ï¼ˆåŒ…æ‹¬çŠ¶æ€å’Œ URLï¼‰
- `_append_new_urls_to_progress` - å°†æ–°å¢ URL å¢é‡è¿½åŠ åˆ°æœ¬åœ°æ–‡ä»¶
- `_create_result` - å°è£…æ”¶é›†ç»“æœå¯¹è±¡

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### BaseCollector ç±»

**åˆå§‹åŒ–å‚æ•°**ï¼š
| å‚æ•°å | ç±»å‹ | æè¿° | é»˜è®¤å€¼ |
|--------|------|------|--------|
| page | `Page` | Playwright é¡µé¢å¯¹è±¡ | å¿…å¡« |
| list_url | `str` | åˆ—è¡¨é¡µ URL | å¿…å¡« |
| task_description | `str` | ä»»åŠ¡æè¿° | å¿…å¡« |
| output_dir | `str` | è¾“å‡ºç›®å½• | "output" |

**æ ¸å¿ƒå±æ€§**ï¼š
| å±æ€§å | ç±»å‹ | æè¿° |
|--------|------|------|
| `collected_urls` | `list[str]` | å·²æ”¶é›†çš„ URL åˆ—è¡¨ |
| `screenshots_dir` | `Path` | æˆªå›¾å­˜å‚¨è·¯å¾„ï¼ˆ`output_dir/screenshots`ï¼‰ |
| `nav_steps` | `list[dict]` | æ¢ç´¢é˜¶æ®µè®°å½•çš„å¯¼èˆªæ­¥éª¤ |
| `common_detail_xpath` | `str` | æå–è¯¦æƒ…é¡µé“¾æ¥çš„å…¬å…± XPath è¡¨è¾¾å¼ |
| `rate_controller` | `AdaptiveRateController` | è‡ªé€‚åº”é€Ÿç‡æ§åˆ¶å™¨ |
| `progress_persistence` | `ProgressPersistence` | è¿›åº¦æŒä¹…åŒ–ç®¡ç†å™¨ |
| `redis_manager` | `RedisQueueManager | None` | Redis ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å™¨ï¼ˆå¯é€‰ï¼‰ |

---

### æ ¸å¿ƒæ–¹æ³•é€»è¾‘

#### _collect_phase_with_xpath()
ä½¿ç”¨å…¬å…± XPath ç›´æ¥æå– URLã€‚
1. **æ™ºèƒ½å…¥å£**ï¼šæ£€æŸ¥ `current_page_num`ã€‚è‹¥å¤§äº 1ï¼ˆæ–­ç‚¹æ¢å¤ï¼‰ï¼Œåˆ™ä»å½“å‰ä½ç½®ç»§ç»­ï¼›å¦åˆ™è¿”å› `list_url` èµ·å§‹ç‚¹ã€‚
2. **é€Ÿç‡æ§åˆ¶**ï¼šåœ¨ç¿»é¡µå‰åº”ç”¨ `rate_controller` å»¶è¿Ÿã€‚
3. **å¾ªç¯æå–**ï¼šæ‰§è¡Œ `_extract_urls_with_xpath` ç›´åˆ°è¾¾åˆ° `max_pages` æˆ– `target_url_count`ã€‚

#### _collect_page_with_llm()
ä½¿ç”¨ LLM æ™ºèƒ½è¯†åˆ«å•é¡µ URLã€‚
1. **SoM æ‰«æ**ï¼šè°ƒç”¨ `inject_and_scan` è·å–é¡µé¢è¯­ä¹‰å¿«ç…§ã€‚
2. **æ–‡æœ¬ä¼˜å…ˆéªŒè¯**ï¼šè°ƒç”¨ `resolve_mark_ids_from_map`ã€‚é‡‡ç”¨â€œæ–‡æœ¬ä¼˜å…ˆ + æ­§ä¹‰é‡é€‰â€é€»è¾‘ï¼Œç¡®ä¿ LLM é€‰æ‹©çš„ Mark ID åœ¨å½“å‰é¡µé¢ä¸Šä¸‹æ–‡æ˜¯å‡†ç¡®çš„ã€‚
3. **URL æå–**ï¼šå¯¹è¯†åˆ«å‡ºçš„å…ƒç´ æ‰§è¡Œ `extract_from_element`ï¼ˆåŒ…å« href è·å–æˆ–ç‚¹å‡»è·³è½¬ï¼‰ã€‚
4. **æ™ºèƒ½æ»šåŠ¨**ï¼šè°ƒç”¨ `smart_scroll` å¤„ç†ç€‘å¸ƒæµæˆ–åŠ¨æ€åŠ è½½é¡µé¢ã€‚

#### _append_new_urls_to_progress()
**æ€§èƒ½ä¼˜åŒ–ç‚¹**ï¼š
åŸºç±»ç»´æŠ¤ `_last_appended_url_count` è®¡æ•°å™¨ã€‚æ¯æ¬¡ä¿å­˜è¿›åº¦æ—¶ï¼Œä»…å°† `collected_urls` ä¸­æ–°å¢çš„éƒ¨åˆ†è¿½åŠ åˆ° `urls.txt`ï¼Œæå¤§å‡å°‘äº†å¤§æ‰¹é‡é‡‡é›†æ—¶çš„æ–‡ä»¶ I/O å¼€é”€ã€‚

---

## ğŸš€ ç‰¹æ€§è¯´æ˜

### æ–­ç‚¹ç»­çˆ¬ä¸çŠ¶æ€æ¢å¤
- **å…¼å®¹æ€§æ£€æŸ¥**ï¼š`_is_progress_compatible` ç¡®ä¿åŠ è½½çš„è¿›åº¦ä¸å½“å‰ `list_url` å’Œä»»åŠ¡æè¿°åŒ¹é…ã€‚
- **å¤šæºåŠ è½½**ï¼š`_load_previous_urls` åŒæ—¶ä» Redis Hash å’Œæœ¬åœ° `urls.txt` åŠ è½½å·²æ”¶é›†æ•°æ®è¿›è¡Œå»é‡ã€‚
- **ç²¾å‡†å®šä½**ï¼šé›†æˆ `ResumeCoordinator`ï¼Œæ”¯æŒé€šè¿‡â€œç›´æ¥è·³è½¬ -> ç¿»é¡µæœç´¢ -> è¯¦æƒ…æ ¡éªŒâ€çš„ä¸‰é˜¶æ®µç­–ç•¥å¿«é€Ÿå®šä½åˆ°ä¸­æ–­é¡µã€‚

### Redis é›†æˆ
- æ”¯æŒåˆ†å¸ƒå¼ä»»åŠ¡åˆ†å‘ã€‚
- åœ¨ `_extract_urls_with_xpath` å’Œ `_collect_page_with_llm` ä¸­ï¼Œæ–°å‘ç°çš„ URL ä¼šå®æ—¶ `push_task` åˆ° Redis é˜Ÿåˆ—ã€‚

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### æ‰©å±• BaseCollector
```python
class MyCollector(BaseCollector):
    async def run(self):
        self._initialize_handlers()
        await self._load_previous_urls() # åŠ è½½å†å²
        # ... ä¸šåŠ¡é€»è¾‘ ...
        await self._collect_phase_with_xpath()
        return self._create_result()
```

---

## ğŸ“Œ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ | æ—¥æœŸ |
|------|----------|------|
| 1.0 | åˆå§‹ç‰ˆæœ¬ | 2026-01-01 |
| 1.3 | æ”¯æŒ Redis æŒä¹…åŒ–ä¸ä¸‰é˜¶æ®µæ¢å¤ç­–ç•¥ | 2026-01-18 |
| 1.4 | ä¼˜åŒ–å¢é‡ I/Oï¼ŒåŒæ­¥ LLM æ–‡æœ¬ä¼˜å…ˆéªŒè¯é€»è¾‘ | 2026-01-22 |

---
*æœ€åæ›´æ–°: 2026-01-22*
