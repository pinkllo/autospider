# AutoSpider - çº¯è§†è§‰ SoM æµè§ˆå™¨ Agent

åŸºäº LangGraph + Playwright + å¤šæ¨¡æ€ LLM çš„çº¯è§†è§‰æµè§ˆå™¨è‡ªåŠ¨åŒ– Agentã€‚é€šè¿‡æ¨¡æ‹Ÿäººç±»è§†è§‰è¯†åˆ«å’Œæ“ä½œä¹ æƒ¯ï¼ŒAutoSpider èƒ½å¤ŸåƒçœŸäººä¸€æ ·ç†è§£ç½‘é¡µã€è¿›è¡Œç­›é€‰å¼•å¯¼ï¼Œå¹¶æœ€ç»ˆè‡ªåŠ¨ç”Ÿæˆç¨³å¥çš„çˆ¬è™«è„šæœ¬ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

- **Set-of-Mark (SoM)** â­ï¼š
    - **æ™ºèƒ½ç¥–å…ˆæ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«å¯ç‚¹å‡»çš„çˆ¶çº§å®¹å™¨ï¼Œé¿å…æ ‡æ³¨çç¢çš„å­å…ƒç´ ï¼Œæ“ä½œæ›´ç²¾å‡†ã€‚
    - **å¤šç»´åº¦å¯è§æ€§æ ¡éªŒ**ï¼šç»“åˆè§†å£æ£€æµ‹ã€Z-index é®æŒ¡åˆ†æåŠå¤šç‚¹é‡‡æ ·éªŒè¯ï¼Œç¡®ä¿åªæ ‡æ³¨çœŸäººå¯è§çš„å…ƒç´ ã€‚
    - **ç¨³å¥ XPath å€™é€‰**ï¼šå†…ç½®å¯å‘å¼ç®—æ³•ï¼ŒæŒ‰ä¼˜å…ˆçº§ç”Ÿæˆæœ€ç¨³å®šçš„å®šä½å™¨ï¼ˆID > TestID > Aria-Label > Text > Relative Pathï¼‰ã€‚
- **å…¨è‡ªåŠ¨è¯¦æƒ…é¡µ URL æ”¶é›†** â­ï¼š
    - **å¯¼èˆªå¼•å¯¼**ï¼šLLM æ ¹æ®è‡ªç„¶è¯­è¨€æŒ‡ä»¤ï¼Œè‡ªåŠ¨åœ¨åˆ—è¡¨é¡µè¿›è¡Œå¤æ‚çš„ç‚¹å‡»ç­›é€‰ï¼ˆå¦‚é€‰æ‹©è¡Œä¸šã€ç»“æœçŠ¶æ€ç­‰ï¼‰ã€‚
    - **æ¨¡å¼æ¢ç´¢**ï¼šè‡ªåŠ¨è¿›å…¥å¤šä¸ªè¯¦æƒ…é¡µï¼Œå­¦ä¹ å¹¶æå–è¯¦æƒ…é“¾æ¥åŠåˆ†é¡µæ§ä»¶çš„å…¬å…± XPath æ¨¡å¼ã€‚
    - **æµ·é‡æ‰¹é‡æ”¶é›†**ï¼šè„±ç¦» LLMï¼Œåˆ©ç”¨æå–çš„æ¨¡å¼è¿›è¡Œé«˜æ€§èƒ½ç¿»é¡µæ”¶é›†ï¼Œæ”¯æŒè‡ªåŠ¨ç¿»é¡µã€‚
- **çˆ¬è™«è„šæœ¬è‡ªåŠ¨ç”Ÿæˆ**ï¼š
    - **ä¸€é”®ç”Ÿæˆ Spider**ï¼šåŸºäºæ”¶é›†é˜¶æ®µæ²‰æ·€çš„ XPaths å’Œ URL åˆ—è¡¨ï¼Œè‡ªåŠ¨ç”Ÿæˆå¯ç‹¬ç«‹è¿è¡Œçš„ Playwright çˆ¬è™«è„šæœ¬ã€‚
    - **é›¶æ¨¡ç‰ˆä¾èµ–**ï¼šç”Ÿæˆçš„è„šæœ¬ç›´æ¥å¯¹æ¥ `urls.txt`ï¼Œæå¤§æé«˜äº†åœ¨å¤§è§„æ¨¡çˆ¬å–æ—¶çš„å¯é æ€§å’ŒæˆåŠŸç‡ã€‚
- **ååçˆ¬æœºåˆ¶**ï¼š
    - **éšæœºåŠ¨ä½œå»¶è¿Ÿ**ï¼šæ¨¡æ‹Ÿäººç±»æ“ä½œé—´éš”ï¼Œæ”¯æŒåŸºç¡€å»¶è¿Ÿ + éšæœºæŠ–åŠ¨é…ç½®ã€‚
    - **åŠ è½½ç­–ç•¥ä¼˜åŒ–**ï¼šæ™ºèƒ½ç­‰å¾…é¡µé¢åŠ è½½çŠ¶æ€åŠ SPA è·¯ç”±æ›´æ–°ã€‚
- **LangGraph é©±åŠ¨**ï¼šobserve (SoM) â†’ decide (LLM) â†’ act (Playwright) â†’ check_done é—­ç¯æµç¨‹ã€‚

## ğŸ› ï¸ å®‰è£…

```bash
# åˆ›å»ºå¹¶æ¿€æ´» conda ç¯å¢ƒ
conda create -n autospider python=3.10 -y
conda activate autospider

# ä»¥å¼€å‘æ¨¡å¼å®‰è£…åŒ…
pip install -e .

# å®‰è£… Playwright æµè§ˆå™¨
playwright install chromium
```

## âš™ï¸ é…ç½®

### 1. ç¯å¢ƒå˜é‡ (.env)

å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶æ ¹æ®å®é™…ä½¿ç”¨çš„ LLM æä¾›å•†å¡«å†™ï¼š

```bash
cp .env.example .env
```

**å…³é”®é…ç½®é¡¹ï¼š**
- `AIPING_API_KEY`: å¤šæ¨¡æ€ LLM çš„ API Keyã€‚
- `AIPING_API_BASE`: API åŸºç¡€è·¯å¾„ï¼ˆé»˜è®¤ä¸º SiliconFlowï¼‰ã€‚
- `AIPING_MODEL`: ä½¿ç”¨çš„å¤šæ¨¡æ€æ¨¡å‹ï¼ˆæ¨è `zai-org/GLM-4.6V` æˆ–å…¶ä»–æ”¯æŒè§†è§‰çš„æ¨¡å‹ï¼‰ã€‚

### 2. çˆ¬å–é—´éš”ä¸è¡Œä¸ºé…ç½®

ä¸ºäº†æ¨¡æ‹Ÿäººç±»è¡Œä¸ºå¹¶è§„é¿åçˆ¬ï¼Œå»ºè®®åœ¨ `.env` ä¸­è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š

```env
# åŸºç¡€æ“ä½œå»¶è¿Ÿï¼ˆç§’ï¼‰
ACTION_DELAY_BASE=1.0
# å»¶è¿Ÿéšæœºæ³¢åŠ¨èŒƒå›´ï¼ˆç§’ï¼‰
ACTION_DELAY_RANDOM=0.5
# é¡µé¢åŠ è½½ç­‰å¾…æ—¶é•¿ï¼ˆç§’ï¼‰
PAGE_LOAD_DELAY=1.5
# æ»šåŠ¨å»¶è¿Ÿ
SCROLL_DELAY=0.5
```

> [!TIP]
> ç³»ç»Ÿçš„æ‰€æœ‰å†…éƒ¨é»˜è®¤å€¼å‡åœ¨ `src/autospider/config.py` ä¸­é›†ä¸­ç®¡ç†ï¼Œéµå¾ª Pydantic å®šä¹‰ã€‚

## ğŸ“– ä½¿ç”¨æŒ‡å—

### 1. äº¤äº’å¼ä»»åŠ¡è¿è¡Œ (`run`)

æ‰§è¡Œç‰¹å®šçš„ä¸€æ­¥æˆ–å¤šæ­¥ä»»åŠ¡ã€‚

```bash
autospider run \
  --start-url "https://example.com" \
  --task "ç‚¹å‡»ç™»å½•æŒ‰é’®ï¼Œè¾“å…¥ xxxï¼Œå¹¶æ£€æŸ¥ç™»å½•çŠ¶æ€" \
  --target-text "æ¬¢è¿ç™»å½•"
```

### 2. è¯¦æƒ…é¡µ URL æ‰¹é‡æ”¶é›† (`collect-urls`) â­

è¿™æ˜¯æœ¬é¡¹ç›®çš„æ——èˆ°åŠŸèƒ½ï¼Œåˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼š**ç­›é€‰å¯¼èˆª -> è¯¦æƒ…æ¢ç´¢ -> æ¨¡å¼æå– -> æ‰¹é‡ç¿»é¡µæ”¶é›†**ã€‚

```bash
autospider collect-urls \
  --list-url "https://xxx.gov.cn/list" \
  --task "æ”¶é›†æ‰€æœ‰å…³äºäº¤é€šå»ºè®¾çš„æ‹›æ ‡å…¬å‘Šè¯¦æƒ…é¡µ" \
  --explore-count 3
```

#### å·¥ä½œæµè¯´æ˜ï¼š
1. **å¼•å¯¼é˜¶æ®µ**ï¼šLLM è§‚å¯Ÿé¡µé¢ï¼Œè‡ªåŠ¨ç‚¹å‡»ç­›é€‰æ¡ä»¶ï¼ˆå¦‚â€œè¿›è¡Œä¸­â€ã€â€œäº¤é€šè¿è¾“â€ï¼‰ã€‚
2. **æ¢ç´¢é˜¶æ®µ**ï¼šLLM å°è¯•ç‚¹å‡»å¹¶è¿›å…¥ N ä¸ªè¯¦æƒ…é¡µï¼Œè®°å½•ç‚¹å‡»è·¯å¾„ã€‚
3. **æ²‰æ·€é˜¶æ®µ**ï¼šç³»ç»Ÿåˆ†æè®°å½•ï¼Œæå–ç¨³å®šä¸”é€šç”¨çš„è¯¦æƒ…é¡µ XPath åŠåˆ†é¡µæŒ‰é’® XPathã€‚
4. **æ”¶é›†é˜¶æ®µ**ï¼šç³»ç»Ÿåˆ©ç”¨æå–çš„ XPath é«˜é€Ÿéå†åˆ—è¡¨å¹¶è‡ªåŠ¨ç¿»é¡µï¼Œå°†æ‰€æœ‰ URL ä¿å­˜åˆ° `output/urls.txt`ã€‚
5. **ç”Ÿæˆé˜¶æ®µ**ï¼šè‡ªåŠ¨ç”Ÿæˆ `output/spider.py`ï¼Œç”¨äºåç»­å†…å®¹çš„æ·±åº¦é‡‡é›†ã€‚

## ğŸ“ è¾“å‡ºäº§ç‰©

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `output/urls.txt` | æ‰¹é‡æ”¶é›†åˆ°çš„è¯¦æƒ…é¡µ URL çº¯æ–‡æœ¬åˆ—è¡¨ |
| `output/spider.py` | **è‡ªåŠ¨ç”Ÿæˆçš„çˆ¬è™«è„šæœ¬**ï¼Œç›´æ¥è¯»å– urls.txt è¿›è¡Œå†…å®¹çˆ¬å– |
| `output/collection_config.json` | æ²‰æ·€ä¸‹æ¥çš„å¯¼èˆªæ­¥éª¤ã€è¯¦æƒ… XPath å’Œåˆ†é¡µ XPath |
| `output/collected_urls.json` | åŒ…å«æ¢ç´¢è¿‡ç¨‹åŠå®Œæ•´ URL åˆ—è¡¨çš„å…ƒæ•°æ®æ–‡ä»¶ |
| `output/screenshots/` | æ•´ä¸ªè¿‡ç¨‹ä¸­æ¯ä¸€æ­¥çš„ SoM è§†è§‰æ ‡æ³¨æˆªå›¾åºåˆ— |

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```mermaid
graph TD
    A[Start URL] --> B[Browser Session]
    B --> C[SoM v2.3 Injector]
    C --> D[Visual Screenshot + Element Marks]
    D --> E[Multimodal LLM Decision]
    E --> F[Playwright Action]
    F --> G{Done?}
    G -- No --> C
    G -- Yes --> H[Output XPaths/URLs/Scripts]
```

## ğŸ“œ è®¸å¯è¯

MIT
